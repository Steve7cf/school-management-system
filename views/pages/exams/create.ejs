<%- include('../../partials/messages') %>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">Schedule New Exam</h2>
                <a href="/exams" class="btn btn-outline-secondary">
                    <img src="/exam.png" alt="Back" style="width: 20px; height: 20px;" class="me-2">
                    Back to Exams
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <form action="/exams" method="POST">
                        <!-- Basic Information -->
                        <div class="mb-4">
                            <h4 class="card-title">Exam Details</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Exam Title</label>
                                    <input type="text" class="form-control" name="title" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Exam Type</label>
                                    <select class="form-select" name="type" required>
                                        <option value="">Select Type</option>
                                        <option value="term">Term</option>
                                        <option value="midterm">Midterm</option>
                                        <option value="annual">Annual</option>
                                        <option value="assignment">Assignment</option>
                                        <option value="test">Test</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Subject</label>
                                    <select class="form-select" name="subject" required>
                                        <option value="">Select Subject</option>
                                        <% subjects.forEach(subject => { %>
                                            <option value="<%= subject._id %>">
                                                <%= subject.name %> (<%= subject.class ? subject.class.name + ' ' + subject.class.section : 'No Class' %>)
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Class</label>
                                    <select class="form-select" name="class" required>
                                        <option value="">Select Class</option>
                                        <% classes.forEach(classItem => { %>
                                            <option value="<%= classItem._id %>">
                                                <%= classItem.name %> <%= classItem.section %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Information -->
                        <div class="mb-4">
                            <h4 class="card-title">Schedule Information</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Date</label>
                                    <input type="datetime-local" class="form-control" name="date" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" class="form-control" name="duration" min="0" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Total Marks</label>
                                    <input type="number" class="form-control" name="totalMarks" min="0" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Passing Marks</label>
                                    <input type="number" class="form-control" name="passingMarks" min="0" required>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="mb-4">
                            <h4 class="card-title">Additional Information</h4>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Instructions</label>
                                    <textarea class="form-control" name="instructions" rows="3"></textarea>
                                    <small class="text-muted">Enter each instruction on a new line</small>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Syllabus</label>
                                    <textarea class="form-control" name="syllabus" rows="3"></textarea>
                                    <small class="text-muted">Enter topics separated by new lines</small>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">
                                <img src="/create.png" alt="Schedule" style="width: 20px; height: 20px;" class="me-2">
                                Schedule Exam
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border: none;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    border-radius: 10px;
}

.form-control,
.form-select {
    border-radius: 5px;
    border: 1px solid #dee2e6;
    padding: 0.5rem 1rem;
}

.form-control:focus,
.form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.card-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1.5rem;
}

textarea.form-control {
    resize: vertical;
}

.btn {
    display: inline-flex;
    align-items: center;
}

.btn img {
    opacity: 0.7;
}

.btn:hover img {
    opacity: 1;
}
</style>

<script>
// Dynamically update class options based on selected subject
document.querySelector('select[name="subject"]').addEventListener('change', function() {
    const subjectId = this.value;
    const classSelect = document.querySelector('select[name="class"]');
    const selectedSubject = Array.from(this.options).find(option => option.value === subjectId);
    
    if (selectedSubject) {
        const classMatch = selectedSubject.textContent.match(/\((.*?)\)/);
        if (classMatch) {
            const className = classMatch[1].replace('No Class', '').trim();
            Array.from(classSelect.options).forEach(option => {
                if (option.textContent.trim() === className) {
                    option.selected = true;
                }
            });
        }
    }
});

// Set minimum date to today
document.querySelector('input[name="date"]').min = new Date().toISOString().slice(0, 16);

// Validate passing marks against total marks
document.querySelector('form').addEventListener('submit', function(e) {
    const totalMarks = parseInt(document.querySelector('input[name="totalMarks"]').value);
    const passingMarks = parseInt(document.querySelector('input[name="passingMarks"]').value);
    
    if (passingMarks > totalMarks) {
        e.preventDefault();
        alert('Passing marks cannot be greater than total marks');
    }

    // Convert instructions and syllabus to arrays
    const instructionsTextarea = document.querySelector('textarea[name="instructions"]');
    const syllabusTextarea = document.querySelector('textarea[name="syllabus"]');
    
    const instructions = instructionsTextarea.value.split('\n').filter(line => line.trim());
    const syllabus = syllabusTextarea.value.split('\n').filter(line => line.trim());
    
    // Create hidden fields for the arrays
    const instructionsInput = document.createElement('input');
    instructionsInput.type = 'hidden';
    instructionsInput.name = 'instructions';
    instructionsInput.value = JSON.stringify(instructions);
    
    const syllabusInput = document.createElement('input');
    syllabusInput.type = 'hidden';
    syllabusInput.name = 'syllabus';
    syllabusInput.value = JSON.stringify(syllabus);
    
    // Replace textareas with hidden fields
    instructionsTextarea.parentNode.replaceChild(instructionsInput, instructionsTextarea);
    syllabusTextarea.parentNode.replaceChild(syllabusInput, syllabusTextarea);
});
</script> 