<%- include('../../partials/messages') %>

<!-- Students List Page -->
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header pb-0">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">Students</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
              <i class="fas fa-plus me-2"></i>Add New Student
            </button>
          </div>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="card mb-4">
            <div class="card-body">
              <form class="row g-2 align-items-end" method="get" action="/students">
                <div class="col-md-4">
                  <label class="form-label">Search (Name or ID)</label>
                  <input type="text" name="search" class="form-control" placeholder="e.g. John or F1/2024/1234" value="<%= typeof search !== 'undefined' ? search : '' %>">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Form</label>
                  <select name="gradeLevel" class="form-select">
                    <option value="">All Forms</option>
                    <% ['1','2','3','4'].forEach(function(form) { %>
                      <option value="<%= form %>" <%= gradeLevel == form ? 'selected' : '' %>>Form <%= form %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Section</label>
                  <select name="section" class="form-select">
                    <option value="">All Sections</option>
                    <% ['A','B','C','D','E'].forEach(function(sec) { %>
                      <option value="<%= sec %>" <%= section == sec ? 'selected' : '' %>><%= sec %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-md-2 d-grid">
                  <button type="submit" class="btn btn-primary">Search/Filter</button>
                </div>
              </form>
            </div>
          </div>
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                  >
                    Student
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                  >
                    Class
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                  >
                    Admission No.
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"
                  >
                    Guardian
                  </th>
                  <th class="text-secondary opacity-7"></th>
                </tr>
              </thead>
              <tbody>
                <% if (students && students.length > 0) { %> <%
                students.forEach(student => { %>
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        <img
                          src="/noAvatar.png"
                          class="avatar avatar-sm me-3"
                          alt="student"
                        />
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">
                          <%= student.firstName %> <%= student.lastName %>
                        </h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">
                      <%= student.gradeLevel ? 'Form ' + student.gradeLevel : 'Not Assigned' %>
                      <%= student.section ? ' Section ' + student.section : '' %>
                    </p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">
                      <%= student.studentId %>
                    </p>
                  </td>
                  <td>
                    <% const parent = parentsMap[student._id]; %>
                    <div class="d-flex flex-column">
                      <h6 class="mb-0 text-sm">
                        <%= parent ? parent.firstName + ' ' + parent.lastName : 'N/A' %>
                      </h6>
                      <p class="text-xs text-secondary mb-0">
                        <%= parent ? parent.email : 'N/A' %>
                      </p>
                    </div>
                  </td>
                  <td class="align-middle">
                    <div class="d-flex gap-2">
                      <a
                        href="/students/edit/<%= student._id %>"
                        class="btn btn-sm btn-info"
                      >
                        <i class="fas fa-edit"></i>
                      </a>
                      <form
                        action="/students/delete/<%= student._id %>"
                        method="POST"
                        class="d-inline"
                        onsubmit="return confirm('Are you sure you want to delete this student?');"
                      >
                        <button type="submit" class="btn btn-sm btn-danger">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                <% }); %> <% } else { %>
                <tr>
                  <td colspan="7" class="text-center py-4">
                    No students found
                  </td>
                </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addStudentModalLabel">Add New Student</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/students/create" method="POST">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">First Name</label>
              <input type="text" name="firstName" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Last Name</label>
              <input type="text" name="lastName" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Date of Birth</label>
              <input type="date" name="dateOfBirth" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Gender</label>
              <select name="gender" class="form-select" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Class</label>
              <select name="class" class="form-select" required>
                <option value="">Select Form</option>
                <% if (typeof classes !== 'undefined' && classes.length > 0) { %>
                  <% Array.from(new Set(classes.map(c => c.gradeLevel))).forEach(form => { %>
                    <option value="<%= form %>">Form <%= form %></option>
                  <% }); %>
                <% } %>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Section</label>
              <select name="section" class="form-select" required>
                <option value="">Select Section</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Address</label>
              <textarea name="address" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Parent/Guardian Name</label>
              <input type="text" name="guardianName" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Relationship</label>
              <select name="guardianRelation" class="form-select" required>
                <option value="">Select Relationship</option>
                <option value="Father">Father</option>
                <option value="Mother">Mother</option>
                <option value="Guardian">Guardian</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Parent/Guardian Phone</label>
              <input type="tel" name="guardianPhone" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Parent/Guardian Email</label>
              <input type="email" name="guardianEmail" class="form-control">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Student</button>
        </div>
      </form>
    </div>
  </div>
</div>

<% if (typeof newStudentId !== 'undefined' && newStudentId) { %>
  <div class="modal fade show" id="studentRegSuccessModal" tabindex="-1" aria-labelledby="studentRegSuccessModalLabel" aria-modal="true" style="display:block; background:rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="studentRegSuccessModalLabel">Student Registered</h5>
          <button type="button" class="btn-close" onclick="closeRegModal()"></button>
        </div>
        <div class="modal-body text-center">
          <h4 class="mb-3">Admission Number</h4>
          <div class="display-6 fw-bold mb-3" style="letter-spacing:2px;">
            <%= newStudentId %>
          </div>
          <% if (typeof newStudentPassword !== 'undefined' && newStudentPassword) { %>
            <h5 class="mb-2">Temporary Password</h5>
            <div class="fw-bold mb-3" style="font-size:1.2rem; letter-spacing:1px;">
              <%= newStudentPassword %>
            </div>
            <p class="mb-0">Please save this Admission Number and password. The student will need them to log in.</p>
          <% } else { %>
            <p class="mb-0">Please save this Admission Number. The student will need it to log in.</p>
          <% } %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="closeRegModal()">OK</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    function closeRegModal() {
      // Remove the query param and hide the modal
      const url = new URL(window.location.href);
      url.searchParams.delete('newStudentId');
      url.searchParams.delete('newStudentPassword');
      window.location.href = url.pathname + url.search;
    }
    // Prevent background scrolling when modal is open
    document.body.classList.add('modal-open');
  </script>
<% } %>

<style>
  .card {
    border: none;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    border-radius: 10px;
  }

  .table th {
    border-top: none;
    background-color: #f8f9fa;
    font-weight: 600;
  }

  .table td {
    vertical-align: middle;
  }

  .btn-group .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-group .btn img {
    opacity: 0.7;
  }

  .btn-group .btn:hover img {
    opacity: 1;
  }

  .input-group-text {
    background-color: #fff;
    border-right: none;
  }

  .input-group .form-control {
    border-left: none;
  }

  .input-group .form-control:focus {
    border-color: #dee2e6;
    box-shadow: none;
  }
</style>

<script>
  // Search functionality
  document.getElementById("searchInput").addEventListener("keyup", function () {
    const searchValue = this.value.toLowerCase();
    const rows = document.querySelectorAll("tbody tr");

    rows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchValue) ? "" : "none";
    });
  });

  // Class filter functionality
  document
    .getElementById("classFilter")
    .addEventListener("change", function () {
      const filterValue = this.value;
      const rows = document.querySelectorAll("tbody tr");

      rows.forEach((row) => {
        if (!filterValue) {
          row.style.display = "";
          return;
        }

        const classCell = row.children[2];
        row.style.display =
          classCell.textContent.trim() === filterValue ? "" : "none";
      });
    });

  // Delete student function
  function deleteStudent(id) {
    if (confirm("Are you sure you want to delete this student?")) {
      fetch(`/students/${id}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then((response) => {
          if (response.ok) {
            window.location.reload();
          } else {
            alert("Error deleting student");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Error deleting student");
        });
    }
  }
</script>
